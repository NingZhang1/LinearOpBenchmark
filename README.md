# Benchmark on Linear Algebra Operations 

这个仓库用于测试不同实现线性代数操作的性能，不同的实现方案包括

1. 手写 C++ 代码 (plain C++)
2. MKL
3. Eigen
4. ISPC
5. 模板循环展开  

## 缓存的影响

下面表格展现了两种测试 ddot 速度的方法，分别见:

* Benchmark/LinearOp/blas1-04-ddot.cpp
* Benchmark/LinearOp/blas1-06-ddot2.cpp
  
| BatchSize | Plain C++ |        |       | Eigen  |        |       | ISPC   |        |       | MKL    |        |        |
|-----------|-----------|--------|-------|--------|--------|-------|--------|--------|-------|--------|--------|--------|
|           | ddot      | ddot2  | Rela  | ddot   | ddot2  | Rela  | ddot   | ddot2  | Rela  | ddot   | ddot2  | Rela   |
| 4         | 1.412     | 2.019  | 1.43  | 2.810  | 3.107  | 1.11  | 0.966  | 1.299  | 1.34  | 0.362  | 0.706  | 1.95   |
| 8         | 2.021     | 2.700  | 1.34  | 3.613  | 3.667  | 1.01  | 2.784  | 3.929  | 1.41  | 0.830  | 1.602  | 1.93   |
| 16        | 2.839     | 3.091  | 1.09  | 5.014  | 3.920  | 0.78  | 4.870  | 3.700  | 0.76  | 1.266  | 2.607  | 2.06   |
| 32        | 2.323     | 2.701  | 1.16  | 6.293  | 3.973  | 0.63  | 7.064  | 4.167  | 0.59  | 2.293  | 3.821  | 1.67   |
| 64        | 1.806     | 2.649  | 1.47  | 5.899  | 3.913  | 0.66  | 6.375  | 4.446  | 0.70  | 3.049  | 4.429  | 1.45   |
| 128       | 1.591     | 2.392  | 1.50  | 5.015  | 3.982  | 0.79  | 8.134  | 4.308  | 0.53  | 4.126  | 4.330  | 1.05   |
| 256       | 1.226     | 2.104  | 1.72  | 4.724  | 4.266  | 0.90  | 8.025  | 4.465  | 0.56  | 4.836  | 4.421  | 0.91   |
| 512       | 1.180     | 1.958  | 1.66  | 4.631  | 4.350  | 0.94  | 7.425  | 4.663  | 0.63  | 4.862  | 4.077  | 0.84   |
| 1024      | 1.128     | 1.965  | 1.74  | 4.504  | 4.729  | 1.05  | 7.832  | 4.467  | 0.57  | 4.457  | 3.731  | 0.84   |
| 2048      | 1.110     | 1.969  | 1.77  | 4.397  | 4.594  | 1.04  | 6.958  | 4.514  | 0.65  | 5.604  | 3.821  | 0.68   |
| 4096      | 1.072     | 2.012  | 1.88  | 4.309  | 4.156  | 0.96  | 6.275  | 4.323  | 0.69  | 5.727  | 3.795  | 0.66   |
| 8192      | 1.120     | 2.010  | 1.79  | 4.115  | 4.302  | 1.05  | 6.343  | 4.718  | 0.74  | 5.517  | 3.658  | 0.66   |
| 16384     | 1.113     | 1.983  | 1.78  | 4.100  | 4.010  | 0.98  | 6.131  | 4.292  | 0.70  | 5.007  | 3.728  | 0.74   |
| 32768     | 1.085     | 1.975  | 1.82  | 3.391  | 4.490  | 1.32  | 5.990  | 4.584  | 0.77  | 4.358  | 3.996  | 0.92   |
| 65536     | 1.102     | 1.950  | 1.77  | 4.245  | 4.601  | 1.08  | 4.205  | 4.372  | 1.04  | 3.980  | 3.877  | 0.97   |
| 131072    | 1.100     | 1.987  | 1.81  | 4.255  | 4.820  | 1.13  | 4.567  | 4.682  | 1.03  | 4.385  | 3.902  | 0.89   |
| 262144    | 1.086     | 1.972  | 1.82  | 4.161  | 4.762  | 1.14  | 4.787  | 4.551  | 0.95  | 3.476  | 4.009  | 1.15   |
| 524288    | 1.086     | 1.990  | 1.83  | 3.418  | 4.302  | 1.26  | 4.396  | 4.723  | 1.07  | 3.247  | 4.164  | 1.28   |
| 1048576   | 1.088     | 1.970  | 1.81  | 2.905  | 4.575  | 1.57  | 2.963  | 4.536  | 1.53  | 2.688  | 3.911  | 1.45   |
| 2097152   | 1.042     | 1.959  | 1.88  | 2.429  | 3.929  | 1.62  | 2.642  | 4.484  | 1.70  | 2.225  | 3.774  | 1.70   |
| 4194304   | 1.017     | 1.981  | 1.95  | 2.127  | 4.516  | 2.12  | 2.409  | 4.610  | 1.91  | 2.346  | 3.784  | 1.61   |
| 8388608   | 0.886     | 2.000  | 2.26  | 1.794  | 4.840  | 2.70  | 2.229  | 4.169  | 1.87  | 2.181  | 3.823  | 1.75   |
| 16777216  | 1.042     | 1.984  | 1.90  | 2.273  | 4.626  | 2.04  | 1.918  | 4.428  | 2.31  | 2.294  | 3.723  | 1.62   |
| 33554432  | 1.013     | 1.979  | 1.95  | 2.458  | 4.639  | 1.89  | 1.983  | 4.685  | 2.36  | 1.990  | 3.824  | 1.92   |

ISPC 的结果见图片: Benchmark/Result/CacheISPC.png

## 小数组的结果

|             | zaxpy  |       | daxpy  |       | ddot   |       | zdot   |       | daxpc  |        |
|-------------|--------|-------|--------|-------|--------|-------|--------|-------|--------|--------|
|             | GFLOPs | Rela. | GFLOPs | Rela. | GFLOPs | Rela. | GFLOPs | Rela. | GFLOPs | Rela.  |
| Plain C++   | 1.144  |       | 1.730  |       | 1.412  |       | 0.563  |       | 1.104  |        |
| Eigen Fixed | 2.611  | 2.28  | 4.413  | 2.55  | 4.373  | 3.10  | 4.110  | 7.30  | 4.309  | 3.90   |
| Template    | 1.312  | 1.15  | 5.403  | 3.12  | 4.457  | 3.16  | 3.755  | 6.67  | -      | -      |
| ispc        | 0.280  | 0.24  | 0.827  | 0.48  | 0.966  | 0.68  | -      | -     | 0.409  | 0.37   |
| MKL         | 0.665  | 0.58  | 0.795  | 0.46  | 0.362  | 0.26  | 0.394  | 0.70  | -      | -      |

NOTE: 
* 数组大小为**4**;
* Rela. 列是各种方法相对于 Plain C++ 的速度. 



## 不同 Linear Algebra Operation 结果 (单线程)

### daxpy

| BatchSize | Plain C++ | Eigen   |       | ISPC    |       | MKL     |        |
|-----------|-----------|---------|-------|---------|-------|---------|--------|
|           | GFLOPs    | GFLOPs  | Rela. | GFLOPs  | Rela. | GFLOPs  | Rela.  |
| 4         | 1.730     | 2.194   | 1.27  | 0.827   | 0.48  | 0.795   | 0.46   |
| 8         | 3.312     | 4.342   | 1.31  | 3.442   | 1.04  | 1.533   | 0.46   |
| 16        | 4.582     | 6.887   | 1.50  | 6.415   | 1.40  | 3.117   | 0.68   |
| 32        | 5.437     | 7.207   | 1.33  | 11.358  | 2.09  | 4.640   | 0.85   |
| 64        | 8.419     | 10.441  | 1.24  | 13.697  | 1.63  | 6.899   | 0.82   |
| 128       | 7.689     | 9.624   | 1.25  | 9.407   | 1.22  | 8.216   | 1.07   |
| 256       | 6.106     | 10.318  | 1.69  | 16.408  | 2.69  | 8.683   | 1.42   |
| 512       | 6.716     | 10.163  | 1.51  | 13.014  | 1.94  | 9.076   | 1.35   |
| 1000      | 8.558     | 10.590  | 1.24  | 13.121  | 1.53  | 9.478   | 1.11   |
| 2000      | 8.560     | 9.908   | 1.16  | 13.952  | 1.63  | 9.858   | 1.15   |
| 4000      | 8.121     | 9.225   | 1.14  | 12.776  | 1.57  | 10.147  | 1.25   |
| 8000      | 7.193     | 10.306  | 1.43  | 11.410  | 1.59  | 9.329   | 1.30   |
| 16000     | 8.385     | 9.328   | 1.11  | 10.001  | 1.19  | 8.663   | 1.03   |
| 32000     | 6.762     | 10.249  | 1.52  | 9.457   | 1.40  | 10.089  | 1.49   |
| 64000     | 7.290     | 8.815   | 1.21  | 9.362   | 1.28  | 8.113   | 1.11   |
| 128000    | 6.979     | 8.796   | 1.26  | 9.256   | 1.33  | 9.311   | 1.33   |
| 256000    | 6.774     | 8.631   | 1.27  | 8.464   | 1.25  | 7.390   | 1.09   |
| 512000    | 6.210     | 7.676   | 1.24  | 7.588   | 1.22  | 8.795   | 1.42   |
| 1000000   | 3.946     | 3.670   | 0.93  | 4.878   | 1.24  | 4.004   | 1.01   |
| 2000000   | 3.638     | 3.023   | 0.83  | 3.132   | 0.86  | 3.191   | 0.88   |
| 4000000   | 4.043     | 4.206   | 1.04  | 3.019   | 0.75  | 4.061   | 1.00   |
| 8000000   | 3.704     | 3.699   | 1.00  | 3.056   | 0.83  | 4.098   | 1.11   |
| 16000000  | 3.421     | 3.213   | 0.94  | 3.239   | 0.95  | 3.700   | 1.08   |
| 32000000  | 2.223     | 3.628   | 1.63  | 3.058   | 1.38  | 3.386   | 1.52   |

NOTE: 
* Rela. 列是各种方法相对于 Plain C++ 的速度. 
* 结果见图片: Benchmark/Result/daxpy.png

### zaxpy

| BatchSize | Plain C++ | Eigen  |       | ISPC   |       | MKL    |        |
|-----------|-----------|--------|-------|--------|-------|--------|--------|
|           | GFLOPs    | GFLOPs | Rela. | GFLOPs | Rela. | GFLOPs | Rela.  |
| 4         | 1.144     | 0.196  | 0.17  | 0.280  | 0.24  | 0.665  | 0.58   |
| 8         | 1.406     | 0.194  | 0.14  | 0.604  | 0.43  | 1.244  | 0.88   |
| 16        | 1.285     | 0.185  | 0.14  | 0.556  | 0.43  | 1.675  | 1.30   |
| 32        | 1.162     | 0.194  | 0.17  | 0.605  | 0.52  | 2.498  | 2.15   |
| 64        | 1.479     | 0.195  | 0.13  | 0.662  | 0.45  | 2.902  | 1.96   |
| 128       | 1.264     | 0.196  | 0.16  | 0.660  | 0.52  | 2.513  | 1.99   |
| 256       | 1.327     | 0.196  | 0.15  | 0.581  | 0.44  | 2.014  | 1.52   |
| 512       | 1.495     | 0.190  | 0.13  | 0.665  | 0.44  | 2.605  | 1.74   |
| 1024      | 1.274     | 0.201  | 0.16  | 0.700  | 0.55  | 2.410  | 1.89   |
| 2048      | 1.375     | 0.192  | 0.14  | 0.591  | 0.43  | 3.362  | 2.45   |
| 4096      | 1.181     | 0.197  | 0.17  | 0.547  | 0.46  | 2.968  | 2.51   |
| 8192      | 1.523     | 0.198  | 0.13  | 0.679  | 0.45  | 2.703  | 1.77   |
| 16384     | 1.406     | 0.195  | 0.14  | 0.554  | 0.39  | 3.359  | 2.39   |
| 32768     | 1.506     | 0.202  | 0.13  | 0.591  | 0.39  | 3.135  | 2.08   |
| 65536     | 1.579     | 0.200  | 0.13  | 0.577  | 0.37  | 3.131  | 1.98   |
| 131072    | 1.605     | 0.198  | 0.12  | 0.546  | 0.34  | 3.135  | 1.95   |
| 262144    | 1.523     | 0.198  | 0.13  | 0.511  | 0.34  | 3.118  | 2.05   |
| 524288    | 1.239     | 0.202  | 0.16  | 0.461  | 0.37  | 2.146  | 1.73   |
| 1048576   | 0.979     | 0.197  | 0.20  | 0.436  | 0.45  | 1.745  | 1.78   |
| 2097152   | 1.215     | 0.190  | 0.16  | 0.426  | 0.35  | 1.799  | 1.48   |
| 4194304   | 1.416     | 0.191  | 0.13  | 0.400  | 0.28  | 1.642  | 1.16   |
| 8388608   | 1.464     | 0.202  | 0.14  | 0.437  | 0.30  | 1.611  | 1.10   |
| 16777216  | 1.244     | 0.128  | 0.10  | 0.533  | 0.43  | 0.808  | 0.65   |


NOTE: 
* Rela. 列是各种方法相对于 Plain C++ 的速度. 
* 结果见图片: Benchmark/Result/zaxpy.png
* Eigen 结果异常 (GFLOPS 过低)，可能代码有问题

### ddot

| BatchSize | Plain C++ | Eigen  |       | ISPC   |       | MKL    |        |
|-----------|-----------|--------|-------|--------|-------|--------|--------|
|           | GFLOPs    | GFLOPs | Rela. | GFLOPs | Rela. | GFLOPs | Rela.  |
| 4         | 1.412     | 2.810  | 1.99  | 0.966  | 0.68  | 0.362  | 0.26   |
| 8         | 2.021     | 3.613  | 1.79  | 2.784  | 1.38  | 0.830  | 0.41   |
| 16        | 2.839     | 5.014  | 1.77  | 4.870  | 1.72  | 1.266  | 0.45   |
| 32        | 2.323     | 6.293  | 2.71  | 7.064  | 3.04  | 2.293  | 0.99   |
| 64        | 1.806     | 5.899  | 3.27  | 6.375  | 3.53  | 3.049  | 1.69   |
| 128       | 1.591     | 5.015  | 3.15  | 8.134  | 5.11  | 4.126  | 2.59   |
| 256       | 1.226     | 4.724  | 3.85  | 8.025  | 6.55  | 4.836  | 3.94   |
| 512       | 1.180     | 4.631  | 3.92  | 7.425  | 6.29  | 4.862  | 4.12   |
| 1024      | 1.128     | 4.504  | 3.99  | 7.832  | 6.94  | 4.457  | 3.95   |
| 2048      | 1.110     | 4.397  | 3.96  | 6.958  | 6.27  | 5.604  | 5.05   |
| 4096      | 1.072     | 4.309  | 4.02  | 6.275  | 5.85  | 5.727  | 5.34   |
| 8192      | 1.120     | 4.115  | 3.67  | 6.343  | 5.66  | 5.517  | 4.93   |
| 16384     | 1.113     | 4.100  | 3.68  | 6.131  | 5.51  | 5.007  | 4.50   |
| 32768     | 1.085     | 3.391  | 3.13  | 5.990  | 5.52  | 4.358  | 4.02   |
| 65536     | 1.102     | 4.245  | 3.85  | 4.205  | 3.82  | 3.980  | 3.61   |
| 131072    | 1.100     | 4.255  | 3.87  | 4.567  | 4.15  | 4.385  | 3.99   |
| 262144    | 1.086     | 4.161  | 3.83  | 4.787  | 4.41  | 3.476  | 3.20   |
| 524288    | 1.086     | 3.418  | 3.15  | 4.396  | 4.05  | 3.247  | 2.99   |
| 1048576   | 1.088     | 2.905  | 2.67  | 2.963  | 2.72  | 2.688  | 2.47   |
| 2097152   | 1.042     | 2.429  | 2.33  | 2.642  | 2.54  | 2.225  | 2.14   |
| 4194304   | 1.017     | 2.127  | 2.09  | 2.409  | 2.37  | 2.346  | 2.31   |
| 8388608   | 0.886     | 1.794  | 2.02  | 2.229  | 2.52  | 2.181  | 2.46   |
| 16777216  | 1.042     | 2.273  | 2.18  | 1.918  | 1.84  | 2.294  | 2.20   |
| 33554432  | 1.013     | 2.458  | 2.43  | 1.983  | 1.96  | 1.990  | 1.96   |


NOTE: 
* Rela. 列是各种方法相对于 Plain C++ 的速度. 
* 结果见图片: Benchmark/Result/ddot.png
* 
### zdot

| BatchSize | Plain C++ | Eigen  |       | MKL    |        |
|-----------|-----------|--------|-------|--------|--------|
|           | GFLOPs    | GFLOPs | Rela. | GFLOPs | Rela.  |
| 4         | 0.563     | 0.745  | 1.32  | 0.394  | 0.70   |
| 8         | 0.626     | 0.916  | 1.46  | 0.644  | 1.03   |
| 16        | 0.587     | 0.904  | 1.54  | 0.958  | 1.63   |
| 32        | 0.720     | 0.916  | 1.27  | 1.080  | 1.50   |
| 64        | 0.758     | 1.124  | 1.48  | 1.588  | 2.09   |
| 128       | 0.636     | 1.144  | 1.80  | 1.634  | 2.57   |
| 256       | 0.725     | 0.967  | 1.33  | 1.818  | 2.51   |
| 512       | 0.663     | 0.903  | 1.36  | 1.774  | 2.68   |
| 1000      | 0.489     | 0.897  | 1.83  | 1.667  | 3.41   |
| 2000      | 0.707     | 1.026  | 1.45  | 1.743  | 2.47   |
| 4000      | 0.607     | 1.066  | 1.76  | 1.704  | 2.81   |
| 8000      | 0.570     | 0.830  | 1.46  | 1.441  | 2.53   |
| 16000     | 0.602     | 0.930  | 1.54  | 1.573  | 2.61   |
| 32000     | 0.661     | 0.899  | 1.36  | 1.345  | 2.03   |
| 64000     | 0.677     | 0.961  | 1.42  | 1.625  | 2.40   |
| 128000    | 0.627     | 0.896  | 1.43  | 1.631  | 2.60   |
| 256000    | 0.698     | 0.974  | 1.40  | 1.392  | 1.99   |
| 512000    | 0.615     | 0.774  | 1.26  | 1.085  | 1.76   |
| 1000000   | 0.700     | 0.604  | 0.86  | 1.129  | 1.61   |
| 2000000   | 0.727     | 0.751  | 1.03  | 1.085  | 1.49   |
| 4000000   | 0.551     | 0.589  | 1.07  | 1.198  | 2.17   |
| 8000000   | 0.598     | 0.519  | 0.87  | 0.885  | 1.48   |
| 16000000  | 0.599     | 0.592  | 0.99  | 0.893  | 1.49   |
| 32000000  | 0.360     | 0.788  | 2.19  | 0.241  | 0.67   |


NOTE: 
* Rela. 列是各种方法相对于 Plain C++ 的速度. 
* 结果见图片: Benchmark/Result/zdot.png

### daxpc (x = ax + constant)

| BatchSize | Plain C++ | Eigen  |       | ISPC    |        |
|-----------|-----------|--------|-------|---------|--------|
|           | GFLOPs    | GFLOPs | Rela. | GFLOPs  | Rela.  |
| 4         | 1.104     | 1.111  | 1.01  | 0.409   | 0.37   |
| 8         | 2.056     | 2.109  | 1.03  | 1.863   | 0.91   |
| 16        | 2.417     | 4.071  | 1.68  | 3.992   | 1.65   |
| 32        | 2.546     | 5.020  | 1.97  | 7.090   | 2.78   |
| 64        | 2.726     | 4.450  | 1.63  | 10.787  | 3.96   |
| 128       | 2.224     | 5.637  | 2.53  | 8.611   | 3.87   |
| 256       | 3.103     | 5.260  | 1.70  | 12.104  | 3.90   |
| 512       | 3.971     | 5.504  | 1.39  | 11.170  | 2.81   |
| 1000      | 4.430     | 5.774  | 1.30  | 10.112  | 2.28   |
| 2000      | 4.195     | 4.879  | 1.16  | 11.170  | 2.66   |
| 4000      | 5.626     | 5.505  | 0.98  | 11.246  | 2.00   |
| 8000      | 4.908     | 5.701  | 1.16  | 10.202  | 2.08   |
| 16000     | 5.758     | 5.456  | 0.95  | 12.696  | 2.20   |
| 32000     | 5.545     | 5.422  | 0.98  | 12.334  | 2.22   |
| 64000     | 5.041     | 6.439  | 1.28  | 11.472  | 2.28   |
| 128000    | 4.522     | 5.326  | 1.18  | 9.496   | 2.10   |
| 256000    | 4.137     | 6.076  | 1.47  | 9.979   | 2.41   |
| 512000    | 5.086     | 6.180  | 1.22  | 10.601  | 2.08   |
| 1000000   | 5.131     | 5.340  | 1.04  | 8.427   | 1.64   |
| 2000000   | 3.676     | 3.918  | 1.07  | 3.600   | 0.98   |
| 4000000   | 3.561     | 2.914  | 0.82  | 2.645   | 0.74   |
| 8000000   | 3.368     | 2.373  | 0.70  | 2.609   | 0.77   |
| 16000000  | 2.921     | 3.069  | 1.05  | 2.806   | 0.96   |
| 32000000  | 3.293     | 2.680  | 0.81  | 3.244   | 0.99   |


NOTE: 
* Rela. 列是各种方法相对于 Plain C++ 的速度. 
* 结果见图片: Benchmark/Result/zdot.png
